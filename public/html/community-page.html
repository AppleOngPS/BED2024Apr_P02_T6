<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Community Page</title>
    <link rel="stylesheet" href="../css/navigation.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f7f9fc;
        margin: 0;
        padding: 0;
      }

      .container {
        width: 70%;
        margin: 100px auto; /* Increased margin-top for visibility */
        padding: 20px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .new-post-button {
        display: block;
        width: 100%;
        padding: 15px;
        background-color: #2c3e50; /* Primary color */
        color: white;
        text-align: center;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        margin-bottom: 20px;
        transition: background-color 0.3s;
      }

      .new-post-button:hover {
        background-color: #34495e; /* Darker shade of primary color */
      }

      .post-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        background-color: #ecf0f1; /* Light secondary color */
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .post-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .post-header div {
        flex-grow: 1;
      }

      .post-header strong {
        font-size: 18px;
        color: #2c3e50; /* Primary color */
      }

      .post-header span {
        color: #95a5a6;
        font-size: 14px;
      }

      .post-body {
        margin-top: 16px;
      }

      .post-body h3 {
        font-size: 22px;
        margin: 0 0 10px 0;
        font-weight: bold;
        color: #2c3e50; /* Primary color */
      }

      .post-body p {
        margin: 0 0 10px 0;
        font-size: 16px;
        line-height: 1.6;
        color: #7f8c8d;
      }

      .category {
        display: inline-block;
        padding: 5px 10px;
        background-color: #bdc3c7; /* Light secondary color */
        border-radius: 5px;
        margin-bottom: 10px;
        font-size: 14px;
        color: #2c3e50; /* Primary color */
      }

      .post-buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 16px;
      }

      .post-buttons button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .delete-button {
        background-color: #e74c3c; /* Accent color */
        color: white;
      }

      .like-button {
        background-color: #e74c3c; /* Accent color */
        color: white;
        border: none;
        border-radius: 50%; /* Circular shape */
        width: 40px; /* Size of the button */
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
        position: relative;
      }

      .like-button:hover {
        background-color: #c0392b; /* Darker shade of accent color */
        transform: scale(1.1); /* Slightly enlarge on hover */
      }

      .like-button span {
        display: none; /* Hide the text inside the button */
      }

      .like-button::before {
        content: "‚ù§";
        font-size: 24px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .delete-button:hover {
        background-color: #c0392b; /* Darker shade of accent color */
      }

      .edit-button {
        background-color: #3498db; /* Secondary color */
        color: white;
      }

      .edit-button:hover {
        background-color: #2980b9; /* Darker shade of secondary color */
      }

      .view-comments-button {
        background-color: #27ae60; /* Success color */
        color: white;
      }

      .view-comments-button:hover {
        background-color: #2ecc71; /* Darker shade of success color */
      }

      .edit-form {
        display: none;
        margin-top: 16px;
      }

      .edit-form input,
      .edit-form textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      .comment-container {
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f1f1f1;
      }

      .comments-section {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button
        class="new-post-button"
        onclick="window.location.href='/html/community.html'"
      >
        Share a New Post
      </button>
      <div id="posts-container"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

        if (loggedInUser) {
          console.log("Logged in user:", loggedInUser);

          try {
            const response = await fetch("/community");
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            const posts = await response.json();

            const postsContainer = document.getElementById("posts-container");
            postsContainer.innerHTML = "";

            posts.forEach((post) => {
              const postElement = document.createElement("div");
              postElement.classList.add("post-container");

              postElement.innerHTML = `
                            <div class="post-header">
                                <div>
                                    <strong>${
                                      post.username || "Unknown"
                                    }</strong> <br>
                                </div>
                            </div>
                            <div class="post-body">
                                <span class="category">#${post.category}</span>
                                <h3>${post.title}</h3>
                                <p>${post.message}</p>
                                <div class="post-buttons">
              <button class="like-button" id="like-button-${
                post.id
              }" onclick="likePost(${post.id})">
                <i class="fa fa-heart"></i> ${post.likes || 0}
              </button>
                                    ${
                                      post.username === loggedInUser.name
                                        ? `<button class="edit-button" onclick="showEditForm(${post.id})">Edit</button>
                                            <button class="delete-button" onclick="deletePost(${post.id})">Delete</button>`
                                        : ""
                                    }
                                    <button class="view-comments-button" onclick="toggleComments(${
                                      post.id
                                    })">View Comments</button>
                                </div>
                            </div>
                            <div class="comments-section" id="comments-section-${
                              post.id
                            }">
                                <div id="comments-container-${post.id}"></div>
                                <form onsubmit="addComment(event, ${post.id})">
                                    <input type="text" id="comment-input-${
                                      post.id
                                    }" placeholder="Add a comment..." required>
                                    <button type="submit">Comment</button>
                                </form>
                            </div>
                            <form class="edit-form" id="edit-form-${post.id}">
                                <label for="edit-title-${
                                  post.id
                                }">Title:</label>
                                <input type="text" id="edit-title-${
                                  post.id
                                }" value="${post.title}">
                                <label for="edit-category-${
                                  post.id
                                }">Category:</label>
                                <input type="text" id="edit-category-${
                                  post.id
                                }" value="${post.category}">
                                <label for="edit-message-${
                                  post.id
                                }">Message:</label>
                                <textarea id="edit-message-${post.id}">${
                post.message
              }</textarea>
                                <button type="button" onclick="submitEdit(${
                                  post.id
                                })">Save</button>
                                <button type="button" onclick="hideEditForm(${
                                  post.id
                                })">Cancel</button>
                            </form>
                        `;

              postsContainer.appendChild(postElement);
              fetchComments(post.id);
            });
          } catch (error) {
            console.error("Error fetching posts:", error);
          }
        } else {
          console.error("User not logged in");
        }
      });

      async function fetchComments(postId) {
        try {
          const response = await fetch(`/community/comments/${postId}`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const comments = await response.json();

          const commentsContainer = document.getElementById(
            `comments-container-${postId}`
          );
          commentsContainer.innerHTML = "";

          comments.forEach((comment) => {
            const commentElement = document.createElement("div");
            commentElement.classList.add("comment-container");

            commentElement.innerHTML = `
                        <p><strong>${
                          comment.username || "Unknown"
                        }</strong> <span>${new Date(
              comment.createdAt
            ).toLocaleString()}</span></p>
                        <p>${comment.comment}</p>
                    `;

            commentsContainer.appendChild(commentElement);
          });
        } catch (error) {
          console.error(
            `Error fetching comments for post ID ${postId}:`,
            error
          );
        }
      }

      async function addComment(event, postId) {
        event.preventDefault();
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!loggedInUser) {
          alert("You need to be logged in to comment.");
          return;
        }

        const commentInput = document.getElementById(`comment-input-${postId}`);
        const comment = commentInput.value;

        try {
          const response = await fetch("/community/comment", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              postId,
              comment,
              userDetails: JSON.stringify(loggedInUser),
            }),
          });

          if (response.ok) {
            commentInput.value = "";
            fetchComments(postId);
          } else {
            const errorData = await response.json();
            alert(`Failed to add comment. ${errorData.error}`);
          }
        } catch (error) {
          alert(`Failed to add comment. ${error.message}`);
        }
      }

      async function likePost(postId) {
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));
        if (!loggedInUser) {
          alert("You need to be logged in to like a post.");
          return;
        }

        try {
          const response = await fetch(`/community/like/${postId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ userId: loggedInUser.id }),
          });

          if (response.ok) {
            alert(`Liked post with ID: ${postId}`);
            location.reload();
          } else {
            const errorData = await response.json();
            alert(`Failed to like post with ID: ${postId}. ${errorData.error}`);
          }
        } catch (error) {
          alert(`Failed to like post with ID: ${postId}. ${error.message}`);
        }
      }

      function toggleComments(postId) {
        const commentsSection = document.getElementById(
          `comments-section-${postId}`
        );
        commentsSection.style.display =
          commentsSection.style.display === "none" ||
          !commentsSection.style.display
            ? "block"
            : "none";
      }

      function showEditForm(postId) {
        const form = document.getElementById(`edit-form-${postId}`);
        form.style.display = "block";
      }

      function hideEditForm(postId) {
        const form = document.getElementById(`edit-form-${postId}`);
        form.style.display = "none";
      }

      async function submitEdit(postId) {
        const title = document.getElementById(`edit-title-${postId}`).value;
        const category = document.getElementById(
          `edit-category-${postId}`
        ).value;
        const message = document.getElementById(`edit-message-${postId}`).value;

        try {
          const response = await fetch(`/community/${postId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ title, category, message }),
          });

          if (response.ok) {
            alert(`Updated post with ID: ${postId}`);
            location.reload();
          } else {
            const errorData = await response.json();
            alert(
              `Failed to update post with ID: ${postId}. ${errorData.error}`
            );
          }
        } catch (error) {
          alert(`Failed to update post with ID: ${postId}. ${error.message}`);
        }
      }

      async function deletePost(postId) {
        try {
          const response = await fetch(`/community/${postId}`, {
            method: "DELETE",
          });

          if (response.ok) {
            alert(`Deleted post with ID: ${postId}`);
            location.reload();
          } else {
            const errorData = await response.json();
            alert(
              `Failed to delete post with ID: ${postId}. ${errorData.error}`
            );
          }
        } catch (error) {
          alert(`Failed to delete post with ID: ${postId}. ${error.message}`);
        }
      }
    </script>
    <script src="../js/navigation.js"></script>
  </body>
</html>
