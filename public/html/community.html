<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Community Sharing Form</title>
    <link rel="stylesheet" href="../css/navigation.css" />
    <link rel="stylesheet" href="../css/styles.css" />
  </head>
  <body>
    <div class="container">
      <h1>Community Sharing</h1>
      <p class="caption">
        What's on your mind? Share your thoughts, ideas, and experiences with
        the community!
      </p>
      <form id="postForm">
        <label for="title">Title:</label>
        <input
          type="text"
          id="title"
          name="title"
          placeholder="Enter a title..."
          required
        />

        <label for="category">Category:</label>
        <select id="category" name="category" required>
          <option value="General">General</option>
          <option value="Events">Events</option>
          <option value="Announcements">Announcements</option>
        </select>

        <label for="message">Message:</label>
        <textarea
          id="message"
          name="message"
          placeholder="Write your message here..."
          required
        ></textarea>

        <button type="submit">Submit</button>
      </form>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

        if (loggedInUser) {
          console.log("Logged in user:", loggedInUser);

          document
            .getElementById("postForm")
            .addEventListener("submit", async function (event) {
              event.preventDefault();
              const formData = new FormData(this);

              formData.append("userDetails", JSON.stringify(loggedInUser));

              const formObject = {};
              formData.forEach((value, key) => (formObject[key] = value));
              const jsonString = JSON.stringify(formObject);

              console.log("Form data before submission:", formObject);

              try {
                const response = await fetch("/community", {
                  method: "POST",
                  body: jsonString,
                  headers: {
                    "Content-Type": "application/json",
                  },
                });

                if (response.ok) {
                  window.location.href = "/html/community-page.html";
                } else {
                  const errorData = await response.json();
                  alert("Error: " + errorData.error);
                }
              } catch (error) {
                alert("Error: " + error.message);
              }
            });
        } else {
          console.error("User not logged in");
        }
      });
    </script>
    <script src="../js/navigation.js"></script>
  </body>
</html>
